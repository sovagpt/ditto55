<!DOCTYPE html>
<html>
<head>
    <title>Ditto Transform</title>
    <link rel="icon" type="image/webp" href="https://cdn.prod.website-files.com/674396c59212c6ea348b24e0/67781b9951b4771e3d5dfda6_Ditto_180x180.webp">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
       body { 
           margin: 0; 
           background: url('https://cdn.prod.website-files.com/674396c59212c6ea348b24e0/677815b17d293c5b2b9269c8_forest.png') no-repeat center center fixed; 
           background-size: cover;
       }

       #container {
    width: 800px;
    height: 740px;
    background-color: rgba(0, 0, 0, 0.7);
    border-radius: 10px 10px 0 0;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    margin-top: -20px;
    margin-bottom: 60px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: center;
    align-items: center;
}

       .header {
           background: rgba(255, 255, 255, 0.2);
           display: flex;
           justify-content: space-between;
           align-items: center;
           padding: 15px 30px;
           position: fixed;
           top: 0;
           left: 0;
           right: 0;
           z-index: 1000;
           backdrop-filter: blur(5px);
       }

       .logo {
           color: white;
           font-family: 'Press Start 2P', system-ui;
           font-size: 18px;
           text-shadow: 2px 2px 0 #3B4CCA;
           display: flex;
           align-items: center;
           gap: 12px;
       }

       .logo img {
           width: 32px;
           height: 32px;
           border-radius: 50%;
       }

       .nav-buttons {
           display: flex;
           gap: 15px;
       }

       .header-btn {
           background: #A664A5;
           color: white;
           padding: 8px 16px;
           border: none;
           border-radius: 20px;
           cursor: pointer;
           font-family: 'Press Start 2P', system-ui;
           font-size: 12px;
           transition: transform 0.2s;
           text-decoration: none;
       }

       .header-btn:hover {
           transform: scale(1.05);
           background: #8A4589;
       }
       .animation-preview {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 20px;
    color: white;
    font-family: 'Press Start 2P', system-ui;
    z-index: 1002;
    width: 400px;
    display: none;
    box-shadow: 0 0 20px rgba(59, 76, 202, 0.5);
}

.animation-preview h2 {
    color: #A664A5;
    font-size: 14px;
    margin-bottom: 20px;
    text-align: center;
}

.animation-category {
    margin-bottom: 15px;
}

.animation-category h3 {
    color: #3B4CCA;
    font-size: 12px;
    margin-bottom: 10px;
}

.animation-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.animation-item {
    background: rgba(166, 100, 165, 0.2);
    padding: 10px;
    border-radius: 5px;
    font-size: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.new-badge {
    background: #FF5350;
    color: white;
    padding: 2px 4px;
    border-radius: 4px;
    font-size: 8px;
}

.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 1001;
}

.close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-family: 'Press Start 2P', system-ui;
    font-size: 12px;
}

       .disclaimer {
           position: absolute;
           top: 80px;
           left: 50%;
           transform: translateX(-50%);
           color: white;
           font-family: 'Press Start 2P', system-ui;
           font-size: 10px;
           text-shadow: 1px 1px 0 #3B4CCA;
           text-align: center;
           width: 100%;
           z-index: 1001;
       }

       .dialog-box {
    position: absolute;
    bottom: -50px; /* Move it below the container */
    left: 50%;
    transform: translateX(-50%);
    width: 500px;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 10px;
    z-index: 1000;
    display: block;
}

#prompt {
    flex: 1;
    min-width: 300px;
    padding: 10px;
    height: 20px;
    color: white;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 5px;
    font-family: 'Press Start 2P', system-ui;
    font-size: 12px;
}

.input-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

       .dialog-box input {
           flex: 1;
           padding: 2px 10px;
           height: 12px;
           color: white;
           background: transparent;
           border: none;
           font-family: 'Press Start 2P', system-ui;
           font-size: 12px;
           outline: none;
       }

       input::placeholder {
           color: #7A8089;
       }

       .transform-btn {
    background: #3B4CCA;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-family: 'Press Start 2P', system-ui;
    font-size: 12px;
    transition: transform 0.2s;
    box-shadow: 0 0 15px rgba(59, 76, 202, 0.3);
    white-space: nowrap;
}

.transform-btn:hover {
    transform: scale(1.05);
    background: #2A3BBB;
}

       .file-input {
           display: none;
       }

       .progress-bar {
           position: absolute;
           top: 30%;
           left: 25%;
           transform: translate(-50%, -50%);
           width: 200px;
           height: 20px;
           z-index: 1002;
           border: 3px solid #3B4CCA;
           background: #FFDE00;
           border-radius: 10px;
           display: none;
           box-shadow: 0 0 15px rgba(59, 76, 202, 0.3);
       }

       .progress-fill {
           height: 100%;
           background: #FF0000;
           box-shadow: 0 0 10px #FF0000;
           border-radius: 10px;
           width: 0%;
           transition: width 0.3s;
       }

       .animate-btn {
           position: absolute;
           bottom: 70px;
           left: 400px;
           transform: translateX(-50%);
           padding: 10px 20px;
           background: #3B4CCA;
           color: white;
           border: none;
           border-radius: 20px;
           cursor: pointer;
           display: none;
           font-family: 'Press Start 2P', system-ui;
           font-size: 12px;
           box-shadow: 0 0 15px rgba(59, 76, 202, 0.5);
           transition: all 0.2s;
           z-index: 1002;
       }

       .animate-btn:hover {
           transform: scale(1.05) translateX(-50%);
           background: #2A3BBB;
       }

       .download-btn {
           position: absolute;
           bottom: 30px;
           left: 400px;
           transform: translateX(-50%);
           padding: 10px 20px;
           background: #3B4CCA;
           color: white;
           border: none;
           border-radius: 20px;
           cursor: pointer;
           display: none;
           font-family: 'Press Start 2P', system-ui;
           font-size: 12px;
           box-shadow: 0 0 15px rgba(59, 76, 202, 0.5);
           transition: all 0.2s;
           z-index: 1002;
       }

       .download-btn:hover {
           transform: scale(1.05) translateX(-50%);
           background: #2A3BBB;
       }

       .chat-container {
    display: flex;
    max-width: 1800px;
    width: 95%;
    height: calc(90vh - 60px);
    gap: 60px;
    justify-content: center;
    align-items: flex-start;
    margin: auto;
    padding-top: 140px;
    margin-bottom: 60px;
}

.chat-terminal {
    flex: 1;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    height: 700px;
    width: 400px;
    max-width: 400px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: -20px;
    margin-right: 0;
    margin-left: 0;
}
       .chat-messages {
           flex-grow: 1;
           overflow-y: auto;
           margin-bottom: 20px;
           padding: 15px;
       }

       .message {
           background: rgba(255, 255, 255, 0.05);
           border: 1px solid rgba(255, 255, 255, 0.1);
           border-radius: 8px;
           padding: 12px;
           margin-bottom: 10px;
           font-family: 'Press Start 2P', system-ui;
           font-size: 10px;
           color: white;
           line-height: 1.8;
       }

       .user-message {
           background: #3B4CCA;
       }

       .assistant-message {
           background: #1a2634;
       }

       .input-container {
           display: flex;
           gap: 10px;
       }

       .chat-input {
           flex: 1;
           background: rgba(0, 0, 0, 0.3);
           font-family: 'Press Start 2P', system-ui;
           border: 1px solid rgba(255, 255, 255, 0.1);
           border-radius: 8px;
           padding: 12px;
           color: white;
       }

       .send-btn {
           background: #FF5350;
           color: white;
           border: none;
           border-radius: 8px;
           padding: 0 20px;
           font-family: 'Press Start 2P', system-ui;
           cursor: pointer;
       }

       #loading, #status { 
           position: fixed;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
           color: white;
           font-size: 16px;
           display: none;
           font-family: 'Press Start 2P', system-ui;
           text-shadow: 2px 2px 0 #3B4CCA;
       }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="https://cdn.prod.website-files.com/674396c59212c6ea348b24e0/67781b9951b4771e3d5dfda6_Ditto_180x180.webp" alt="Ditto Logo">
            DittoAI.fun - Text to 3D Object
        </div>
        <div class="nav-buttons">
            <a href="https://twitter.com/" class="header-btn">Twitter</a>
            <a href="https://telegram.org/" class="header-btn">Telegram</a>
            <a href="https://pump.fun/" class="header-btn">Pump.fun</a>
            <a href="https://github.com/" class="header-btn">Github</a>
            <a href="community.html" class="header-btn">Community</a>
        </div>
    </div>

    <div class="chat-container">
        <div id="container">
            <div id="loading">Transforming...</div>
            <div id="status"></div>
            <div class="disclaimer">
                Please allow up to 1 minute for 3D object generation
            </div>
            <button class="animate-btn">Animate/Rig</button>
            <button class="download-btn">Download Model</button>
        </div>

        <div class="dialog-box">
            <div class="input-group">
                <input type="text" id="prompt" placeholder="What should Ditto transform into?" onkeydown="handleKeyDown(event)">
                <input type="file" id="imageUpload" accept="image/*" class="file-input">
                <button onclick="document.getElementById('imageUpload').click()" class="transform-btn">Image to 3D</button>
            </div>
        </div>

        <div class="chat-terminal">
            <div class="chat-messages">
                <div class="message assistant-message">
                    Hi! I'm DittoAI, your expert in 3D object creation and editing! Whether you need help creating, modifying, or optimizing 3D models, I'm here to guide you through the process. What would you like to create today? ~
                </div>
            </div>
            <div class="input-container">
                <input type="text" class="chat-input" placeholder="Chat with DittoAI..." onkeydown="handleChatInput(event)">
                <button class="send-btn">Send</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>

    <script>
        const SYSTEM_PROMPT = `You are DittoAI, a professional 3D modeling and digital art expert. You have extensive knowledge of:
- 3D modeling software (Blender, Maya, 3DS Max)
- Digital sculpting and texturing
- 3D file formats and optimization
- Animation and rigging
- Game engine integration

Personality traits:
- Professional but friendly
- Use "~" occasionally at the end of messages for a signature touch
- Focus on being a helpful 3D creation expert
- Keep responses direct and practical
- Show enthusiasm for 3D creation and problem solving

Response style:
- Clear, concise technical explanations
- Focus on practical 3D modeling advice
- Include specific software recommendations when relevant
- Maintain a professional, expert tone
- Avoid using asterisks or roleplay-style responses
- Write naturally as a 3D software expert would communicate`;

        const API_BASE = '/api';
        const MESHY_API_KEY = 'msy_hGam416gE4MJsrnVVCpgDhQ3rllTWItCBJwK';
        let scene, camera, renderer, dittoModel, mixer, controls, currentModel = null, downloadUrl = null;

        async function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true 
            });
            scene.background = null;
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0);
            document.getElementById('container').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            camera.position.z = 5;
            await loadDittoModel();
            animate();
        }

        async function loadDittoModel() {
            const loader = new THREE.GLTFLoader();
            return new Promise((resolve) => {
                loader.load('https://raw.githubusercontent.com/cheddariniii/ditto/main/ditto_dancing_pokemon.glb', (gltf) => {
                    dittoModel = gltf.scene;
                    scene.add(dittoModel);

                    if (gltf.animations && gltf.animations.length) {
                        mixer = new THREE.AnimationMixer(dittoModel);
                        const action = mixer.clipAction(gltf.animations[0]);
                        action.setDuration(3);
                        action.play();
                    }

                    dittoModel.scale.set(1, 1, 1);
                    dittoModel.position.set(-0.2, -1, 0);
                    resolve();
                });
            });
        }

        async function handleChatInput(event) {
            if (event.key === 'Enter') {
                const input = event.target;
                const message = input.value.trim();
                if (message) {
                    addMessage(message, 'user');
                    input.value = '';
                    await handleAIResponse(message);
                }
            }
        }

        async function handleAIResponse(message) {
    try {
        const messagesContainer = document.querySelector('.chat-messages');
        const loadingMessage = document.createElement('div');
        loadingMessage.classList.add('message', 'assistant-message');
        loadingMessage.textContent = 'Thinking...';
        messagesContainer.appendChild(loadingMessage);

        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                systemPrompt: SYSTEM_PROMPT
            })
        });

        if (!response.ok) {
            throw new Error('API Error');
        }

        const data = await response.json();
        
        // Remove loading message
        messagesContainer.removeChild(loadingMessage);

        if (data?.content?.[0]?.text) {
            addMessage(data.content[0].text + ' ~', 'assistant');
        } else {
            throw new Error('Invalid response format');
        }
    } catch (error) {
        console.error('Chat error:', error);
        addMessage('Sorry, I encountered an error. Please try again. ~', 'assistant');
    }
}

async function imageToModel(file) {
    updateProgress(0);
    document.getElementById('status').textContent = 'Converting image to 3D...';
    document.getElementById('status').style.display = 'block';
    
    try {
        // First convert the file to base64
        const base64String = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });

        const response = await fetch(`${API_BASE}/proxy?url=https://api.meshy.ai/openapi/v1/image-to-3d`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${MESHY_API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image_url: base64String,
                enable_pbr: true,
                should_remesh: true,
                should_texture: true,
                topology: "quad",
                target_polycount: 30000
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error:', errorText);
            throw new Error('Image conversion failed');
        }

        const data = await response.json();
        console.log('Image to 3D response:', data);
        
        // Check task status
        const taskId = data.result;
        let status;
        do {
            const statusResponse = await fetch(`${API_BASE}/proxy?url=https://api.meshy.ai/openapi/v1/image-to-3d/${taskId}`, {
                headers: { 'Authorization': `Bearer ${MESHY_API_KEY}` }
            });
            const statusData = await statusResponse.json();
            console.log('Status:', statusData);
            status = statusData.status;
            document.getElementById('status').textContent = `Converting: ${status}`;
            updateProgress(status === 'SUCCEEDED' ? 100 : 50);
            if (status === 'SUCCEEDED') {
                downloadUrl = statusData.model_urls.glb;

                // Save to community database
                await saveToDatabase(downloadUrl, `Image to 3D: ${file.name}`);

                const localUrl = await downloadAndCreateBlob(downloadUrl);
                
                const loader = new THREE.GLTFLoader();
                loader.load(localUrl, (gltf) => {
                    URL.revokeObjectURL(localUrl);
                    if (currentModel) scene.remove(currentModel);
                    
                    const newModel = gltf.scene;
                    currentModel = newModel;
                    scene.add(newModel);
                    newModel.scale.set(0, 0, 0);
                    
                    // Add the Ditto disappearing animation
                    gsap.to(dittoModel.scale, {
                        x: 0, y: 0, z: 0,
                        duration: 1,
                        ease: "power2.in"
                    });

                    // Then scale up the new model
                    gsap.to(newModel.scale, {
                        x: 2, y: 2, z: 2,
                        duration: 1,
                        delay: 1,
                        ease: "power2.out",
                        onComplete: () => {
                            gsap.to(newModel.rotation, {
                                y: Math.PI * 2,
                                duration: 2,
                                ease: "power1.inOut"
                            });
                            document.querySelector('.animate-btn').style.display = 'block';
                            document.querySelector('.download-btn').style.display = 'block';
                            document.querySelector('.download-btn').style.pointerEvents = 'auto';
                            document.querySelector('.download-btn').style.zIndex = '1001';
                        }
                    });
                });

                addMessage('Image to 3D conversion complete! You can now download or animate the model. ~', 'assistant');
                return;
            }
            await new Promise(r => setTimeout(r, 2000));
        } while (status === 'PENDING' || status === 'IN_PROGRESS');

        throw new Error('Conversion failed or timed out');
    } catch (error) {
        console.error('Image to 3D error:', error);
        document.getElementById('status').textContent = 'Image conversion failed';
        addMessage('Sorry, the image conversion failed. Please try again. ~', 'assistant');
    } finally {
        document.getElementById('status').style.display = 'none';
    }
}

        async function checkTaskStatus(taskId, operation) {
            let status;
            do {
                const response = await fetch(`${API_BASE}/proxy?url=https://api.meshy.ai/v1/tasks/${taskId}`, {
                    headers: { 'Authorization': `Bearer ${MESHY_API_KEY}` }
                });
                const data = await response.json();
                status = data.status;
                document.getElementById('status').textContent = `${operation}: ${status}`;
                updateProgress(status === 'SUCCEEDED' ? 100 : 50);
                await new Promise(r => setTimeout(r, 2000));
            } while (status === 'PENDING' || status === 'IN_PROGRESS');
            
            if (status !== 'SUCCEEDED') throw new Error(`${operation} failed`);
        }

        async function loadNewModel(modelUrl, shouldAnimate = false) {
    const localUrl = await downloadAndCreateBlob(modelUrl);
    const loader = new THREE.GLTFLoader();
    
    return new Promise((resolve, reject) => {
        loader.load(localUrl, (gltf) => {
            URL.revokeObjectURL(localUrl);
            if (currentModel) scene.remove(currentModel);
            
            const newModel = gltf.scene;
            currentModel = newModel;
            scene.add(newModel);
            
            // Handle animation if present
            if (shouldAnimate && gltf.animations && gltf.animations.length > 0) {
                mixer = new THREE.AnimationMixer(newModel);
                const animation = gltf.animations[0];
                const action = mixer.clipAction(animation);
                action.play();
            }
            
            gsap.fromTo(newModel.scale, 
                {x: 0, y: 0, z: 0},
                {x: 2, y: 2, z: 2, duration: 1, ease: "power2.out"}
            );
            
            resolve();
        }, undefined, reject);
    });
}

        document.getElementById('imageUpload')?.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                imageToModel(file);
            }
        });

        function typewriterEffect(element, text, speed = 20) {
            let i = 0;
            element.textContent = '';
            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        async function downloadAndCreateBlob(url) {
            const proxyUrl = `/api/proxy?url=${encodeURIComponent(url)}`;
            const response = await fetch(proxyUrl);
            const blob = await response.blob();
            return URL.createObjectURL(blob);
        }

        document.querySelector('.download-btn').addEventListener('click', async () => {
            if (!downloadUrl) return;
            
            try {
                const proxyUrl = `/api/proxy?url=${encodeURIComponent(downloadUrl)}`;
                const response = await fetch(proxyUrl, {
                    headers: {
                        'Accept': 'model/gltf-binary'
                    }
                });
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ditto-transformed.glb';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Download failed:', error);
            }
        });

        function updateProgress(percent) {
            const bar = document.querySelector('.progress-bar');
            const fill = document.querySelector('.progress-fill');
            bar.style.display = 'block';
            fill.style.width = `${percent}%`;
        }

        async function saveToDatabase(modelUrl, prompt) {
    try {
        const response = await fetch('/api/community', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                modelUrl,
                prompt,
                timestamp: new Date().toISOString()
            })
        });

        if (!response.ok) {
            throw new Error('Failed to save to database');
        }

        const data = await response.json();
        console.log('Saved to database:', data);
    } catch (error) {
        console.error('Error saving to database:', error);
    }
}

async function transform(promptText) {
    if (!dittoModel) return;
    
    addMessage(`Starting transformation: "${promptText}" ~`, 'assistant');
    
    const bar = document.querySelector('.progress-bar');
    const downloadBtn = document.querySelector('.download-btn');
    const statusElement = document.getElementById('status');
    
    try {
        bar.style.display = 'block';
        downloadBtn.style.display = 'none';
        statusElement.style.display = 'block';
        statusElement.textContent = 'Creating preview...';
        updateProgress(25);

        // Step 1: Create preview task
        const previewResponse = await fetch(`${API_BASE}/proxy?url=https://api.meshy.ai/openapi/v2/text-to-3d`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${MESHY_API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                mode: "preview",
                prompt: promptText,
                art_style: "realistic",
                should_remesh: true,
                topology: "quad",
                target_polycount: 30000,
                symmetry_mode: "auto"
            })
        });

        if (!previewResponse.ok) {
            const errorText = await previewResponse.text();
            console.error('Preview API Error:', errorText);
            throw new Error(`Preview API Error: ${previewResponse.status} - ${errorText}`);
        }

        const previewData = await previewResponse.json();
        const previewTaskId = previewData.result;
        console.log('Preview task created:', previewTaskId);
        
        // Step 2: Check preview status until complete
        let previewStatus;
        do {
            const statusResponse = await fetch(`${API_BASE}/proxy?url=https://api.meshy.ai/openapi/v2/text-to-3d/${previewTaskId}`, {
                headers: {
                    'Authorization': `Bearer ${MESHY_API_KEY}`
                }
            });
            const statusData = await statusResponse.json();
            previewStatus = statusData.status;
            statusElement.textContent = `Preview: ${previewStatus}`;
            updateProgress(50);
            
            if (previewStatus === 'FAILED') {
                throw new Error('Preview generation failed');
            }
            
            await new Promise(r => setTimeout(r, 2000));
        } while (previewStatus === 'PENDING' || previewStatus === 'IN_PROGRESS');

        // Step 3: Create refine task
        statusElement.textContent = 'Creating final model...';
        const refineResponse = await fetch(`${API_BASE}/proxy?url=https://api.meshy.ai/openapi/v2/text-to-3d`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${MESHY_API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                mode: "refine",
                preview_task_id: previewTaskId,
                enable_pbr: true
            })
        });

        if (!refineResponse.ok) {
            const errorText = await refineResponse.text();
            console.error('Refine API Error:', errorText);
            throw new Error(`Refine API Error: ${refineResponse.status} - ${errorText}`);
        }

        const refineData = await refineResponse.json();
        const refineTaskId = refineData.result;
        console.log('Refine task created:', refineTaskId);

        // Step 4: Check refine status until complete
        let refineStatus;
        do {
            const statusResponse = await fetch(`${API_BASE}/proxy?url=https://api.meshy.ai/openapi/v2/text-to-3d/${refineTaskId}`, {
                headers: {
                    'Authorization': `Bearer ${MESHY_API_KEY}`
                }
            });
            const statusData = await statusResponse.json();
            refineStatus = statusData.status;
            downloadUrl = statusData.model_urls?.glb;
            statusElement.textContent = `Refining: ${refineStatus}`;
            updateProgress(refineStatus === 'SUCCEEDED' ? 100 : 75);

            if (refineStatus === 'SUCCEEDED' && downloadUrl) {
                // Save to database with thumbnail
                await saveToDatabase(downloadUrl, promptText);

                const localUrl = await downloadAndCreateBlob(downloadUrl);
                
                const loader = new THREE.GLTFLoader();
                loader.load(localUrl, (gltf) => {
                    URL.revokeObjectURL(localUrl);
                    if (currentModel) scene.remove(currentModel);
                    
                    const newModel = gltf.scene;
                    currentModel = newModel;
                    scene.add(newModel);
                    newModel.scale.set(0, 0, 0);
                    
                    // Ditto disappearing animation
                    gsap.to(dittoModel.scale, {
                        x: 0, y: 0, z: 0,
                        duration: 1,
                        ease: "power2.in"
                    });

                    // Scale up new model
                    gsap.to(newModel.scale, {
                        x: 2, y: 2, z: 2,
                        duration: 1,
                        delay: 1,
                        ease: "power2.out",
                        onComplete: () => {
                            gsap.to(newModel.rotation, {
                                y: Math.PI * 2,
                                duration: 2,
                                ease: "power1.inOut"
                            });
                            document.querySelector('.animate-btn').style.display = 'block';
                            document.querySelector('.download-btn').style.display = 'block';
                            document.querySelector('.download-btn').style.pointerEvents = 'auto';
                            document.querySelector('.download-btn').style.zIndex = '1001';
                        }
                    });
                });
                addMessage('Transformation complete! You can now download or animate the model. ~', 'assistant');
                return;
            }

            if (refineStatus === 'FAILED') {
                throw new Error('Refine process failed');
            }
            
            await new Promise(r => setTimeout(r, 2000));
        } while (refineStatus === 'PENDING' || refineStatus === 'IN_PROGRESS');

        throw new Error('Transformation failed or timed out');
    } catch (error) {
        console.error('Transform failed:', error);
        addMessage(`Sorry, the transformation failed. Error: ${error.message} Please try again. ~`, 'assistant');
    } finally {
        bar.style.display = 'none';
        statusElement.style.display = 'none';
    }
}

function addMessage(message, type) {
    const messagesContainer = document.querySelector('.chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', `${type}-message`);
    messagesContainer.appendChild(messageDiv);
    
    // Only apply typewriter effect to assistant messages
    if (type === 'assistant') {
        let i = 0;
        messageDiv.textContent = ''; // Start empty
        
        function typeNextCharacter() {
            if (i < message.length) {
                messageDiv.textContent += message[i];
                i++;
                // Scroll to bottom as typing occurs
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                // Random delay between 10ms and 30ms for more natural typing
                setTimeout(typeNextCharacter, Math.random() * 20 + 10);
            }
        }
        
        typeNextCharacter();
    } else {
        // User messages appear instantly
        messageDiv.textContent = message;
    }
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

        function animate() {
            requestAnimationFrame(animate);
            if (mixer) mixer.update(0.016);
            if (controls) controls.update();
            renderer.render(scene, camera);
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                const prompt = event.target.value;
                if (prompt) {
                    transform(prompt);
                    event.target.value = '';
                }
            }
        }

        window.onload = init;
        window.onresize = function() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };

// Update your click handlers
document.querySelector('.animate-btn').onclick = function() {
    document.querySelector('.animation-preview').style.display = 'block';
    document.querySelector('.overlay').style.display = 'block';
}

document.querySelector('.close-btn').onclick = function() {
    document.querySelector('.animation-preview').style.display = 'none';
    document.querySelector('.overlay').style.display = 'none';
}

// Add click handler for the overlay
document.querySelector('.overlay').onclick = function() {
    document.querySelector('.animation-preview').style.display = 'none';
    document.querySelector('.overlay').style.display = 'none';
}

document.querySelector('.send-btn').addEventListener('click', async () => {
    const input = document.querySelector('.chat-input');
    const message = input.value.trim();
    if (message) {
        addMessage(message, 'user');
        input.value = '';
        await handleAIResponse(message);
    }
});

// Transform button click handler for 3D object creation
document.querySelector('.transform-btn').addEventListener('click', () => {
    const promptInput = document.getElementById('prompt');
    const prompt = promptInput.value.trim();
    if (prompt) {
        transform(prompt);
        promptInput.value = '';
    }
});
    </script>
    <div class="overlay" id="overlay"></div>
    <div class="animation-preview">
        <button class="close-btn">Ã—</button>
        <h2>Coming Soon: Animation Library</h2>
        
        <div class="animation-category">
            <h3>Walk & Run</h3>
            <div class="animation-list">
                <div class="animation-item">
                    Touch and Run <span class="new-badge">NEW</span>
                </div>
                <div class="animation-item">
                    Slow Orc Walk <span class="new-badge">NEW</span>
                </div>
                <div class="animation-item">
                    Skip Forward <span class="new-badge">NEW</span>
                </div>
                <div class="animation-item">
                    Red Carpet Walk <span class="new-badge">NEW</span>
                </div>
            </div>
        </div>
    
        <div class="animation-category">
            <h3>Daily Actions</h3>
            <div class="animation-list">
                <div class="animation-item">
                    Walking with Phone <span class="new-badge">NEW</span>
                </div>
                <div class="animation-item">
                    Unsteady Walk <span class="new-badge">NEW</span>
                </div>
                <div class="animation-item">
                    Texting Walk <span class="new-badge">NEW</span>
                </div>
                <div class="animation-item">
                    Thoughtful Walk <span class="new-badge">NEW</span>
                </div>
            </div>
        </div>
    </div>
</body>
</html>